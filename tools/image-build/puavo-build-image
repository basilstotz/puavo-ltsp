#!/usr/bin/ruby1.9.1

require 'json'

# XXX probably not
def get_rules_directories()
  config_file_path = "#{ ENV['HOME'] }/.config/puavo-build-image/defaults"

  IO.readlines(config_file_path).each do |line|
    key, value = * line.split
    if key == 'buildrules-dirs' then
      return value.split(',')
    end
  end

  raise 'Could not found rule directories'
end

def get_image_configurations()
  ruledirs = get_rules_directories()

  imageconfs = {}

  imageconf_files = ruledirs.map { |s| "#{ s }/images.json" } \
                            .select { |path| File.exists?(path) }
  imageconf_files.each do |jsonfile_path|
    imageconfs.merge!( JSON.parse( File.read(jsonfile_path) ) )
  end

  imageconfs
end

p get_image_configurations()
