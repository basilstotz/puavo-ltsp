#!/usr/bin/ruby1.9.1

require 'getoptlong'
require 'json'

def image_configuration(imagejson_path)
  JSON.parse( File.read(imagejson_path) )
end

def output_makefile(image_confs)
  makefile = []

  image_confs.keys.each do |imagetype|
    makefile << <<-EOF
.PHONY: #{ imagetype }
#{ imagetype }:
	@sudo puavo-build-image --config-template $@
EOF
  end

  puts makefile.join("\n")
end

def usage()
  puts <<-EOF
You use me wrong, use better!
EOF
  exit(1)
end

config_file = nil
output_makefile = false

begin
  opts = GetoptLong.new(
           [ '--config',          '-c', GetoptLong::REQUIRED_ARGUMENT ],
           [ '--output-makefile', '-m', GetoptLong::NO_ARGUMENT       ])

  opts.each do |opt, arg|
    case opt
      when '--config'
	config_file = arg
      when '--output-makefile'
	output_makefile = true
    end
  end
rescue GetoptLong::InvalidOption => e
  usage
end

if output_makefile && config_file then
  output_makefile( image_configuration(config_file) )
  exit(0)
else
  usage()
end
