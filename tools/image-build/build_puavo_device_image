#!/bin/sh

set -e

user=${user:-$SUDO_USER}
user=${user:-$USER}

option=$1
option_argument=$2

set -u

# these should probably be some kind of parameters:
arch=i386
distribution=trusty
mirror=fi.archive.ubuntu.com

mirror_through_apt_cacher="http://localhost:3142/$mirror/ubuntu/"

images_dir="/opt/puavo/images"
target_dir="/virtualtmp/$user/$distribution"
puppet_pdip_dir="$target_dir/etc/puppet/pdip"

build_date=$(date +%Y-%m-%d-%H%M%S)
build_version=pdip-$distribution-$build_date
pdipimage_name="$build_version-$arch.img"

do_mounts() {
  mount -o bind /dev     "$target_dir/dev"
  mount -o bind /dev/pts "$target_dir/dev/pts"
  mount -o bind /proc    "$target_dir/proc"
}

do_umounts() {
  # umount -l or -f ?  (XXX -f did not seem to work)
  umount -l "$target_dir/dev/pts"
  umount -l "$target_dir/dev"
  umount -l "$target_dir/proc"
}

wipe_chroot() {
  do_umounts 2>/dev/null || true
  rm -rf "$target_dir"
}

check_puppet_class() {
  if [ -z "$1" ]; then
    echo 'Did not define a puppet class, exiting...' >&2
    return 1
  fi
}

ask_and_set_image_information() {
  old_release_name=
  read old_release_name 2>/dev/null \
    < "$target_dir/etc/ltsp/this_ltspimage_release" || true

  read -p "Release name [${old_release_name}]: " new_release_name
  new_release_name=${new_release_name:-${old_release_name}}

  mkdir -p $target_dir/etc/ltsp
  echo "$pdipimage_name"   > "$target_dir/etc/ltsp/this_ltspimage_name"
  echo "$new_release_name" > "$target_dir/etc/ltsp/this_ltspimage_release"

  while true; do
    read -p 'Set root password [y/N] ? ' do_set_rootpw
    case "$do_set_rootpw" in
       '')                       break                       ;;
      Y|y) run_in_chroot passwd; break                       ;;
      N|n)                       break                       ;;
        *) echo 'Simple question, simple answer please!' >&2 ;;
    esac
  done
}

build_chroot() {
  wipe_chroot

  run_with_setarch \
    debootstrap --arch=i386 \
		--components=main,restricted,universe,multiverse \
		trusty "$target_dir" "$mirror_through_apt_cacher"

  # setup apt sources list

  cat <<'EOF' > "$target_dir/etc/apt/sources.list.d/archive.list"
deb http://archive.opinsys.fi/git-trusty trusty main restricted universe multiverse
deb-src http://archive.opinsys.fi/git-trusty trusty main restricted universe multiverse
EOF

  # setup policy-rc.d (so that daemons are not started when installing)

  cat <<'EOF' > "$target_dir/usr/sbin/policy-rc.d"
#!/bin/sh
[ "$DISABLE_DAEMONS" != "" ] && exit 101
EOF
  chmod 755 "$target_dir/usr/sbin/policy-rc.d"

  # the install script

  cat <<'EOF' > "$target_dir/root/install.sh"
#!/bin/sh

set -eu

export DEBIAN_FRONTEND=noninteractive
export DISABLE_DAEMONS=1

apt-get update
apt-get -y install linux-image-generic

cd /boot
for vmlinuz in vmlinuz-*; do
  test -e "$vmlinuz" || break
  kernel_version=${vmlinuz##vmlinuz-}
  ln -s "vmlinuz-$kernel_version"    vmlinuz
  ln -s "initrd.img-$kernel_version" initrd.img
done
EOF
  chmod 755 "$target_dir/root/install.sh"

  run_in_chroot /root/install.sh
}

set_debconf_seeds() {
  run_in_chroot debconf-set-selections < config/debconf.seeds
}

prepare_puppet() {
  puppet_classes=$1

  puppet_module_dirs=$(
    echo puppet/* \
      | xargs -n 1 basename  \
      | xargs -n 1 printf "/etc/puppet/pdip/%s\n" \
      | xargs \
      | tr ' ' ':')

  run_in_chroot apt-get -qq -y install puppet-common

  mkdir -p "$puppet_pdip_dir"
  echo "$puppet_classes"     > "$puppet_pdip_dir/.classes"
  echo "$puppet_module_dirs" > "$puppet_pdip_dir/.module_dirs"
}

apply_puppet() {
  puppet_classes=$(cat $target_dir/etc/puppet/pdip/.classes)
  puppet_module_dirs=$(cat $target_dir/etc/puppet/pdip/.module_dirs)

  rm -rf $puppet_pdip_dir/*
  cp -HR puppet/* "$puppet_pdip_dir"

  logfile_path="/var/log/puppet/pdip-$(date +%Y-%m-%d-%H%M%S).log"
  run_in_chroot puppet apply                          \
		  --detailed-exitcodes                \
		  --logdest console                   \
		  --logdest "$logfile_path"           \
		  --execute "include $puppet_classes" \
		  --modulepath "$puppet_module_dirs"  \
    || [ $? -eq 2 ]
}

run_in_chroot() {
  do_mounts
  run_with_setarch chroot "$target_dir" env DISABLE_DAEMONS=1 "$@"
  do_umounts
}

run_with_setarch() {
  # i386 is hardcoded for now
  setarch i386 "$@"
}

make_image() {
  ask_and_set_image_information

  mkdir -p "$images_dir"
  mksquashfs "$target_dir" "$images_dir/${pdipimage_name}.tmp" \
	     -noappend \
	     -ef config/pdip-image.excludes \
	     -wildcards
  mv "$images_dir/${pdipimage_name}.tmp" "$images_dir/${pdipimage_name}"
}

cleanup() {
  do_umounts 2>/dev/null || true
}

trap cleanup 0 INT TERM

if [ "$(id -u)" -ne 0 ]; then
  echo 'Run me as root' >&2
  exit 1
fi

case "$option" in
  --build-all-for)
    check_puppet_class "$option_argument"

    $0 --build-chroot
    $0 --prepare-puppet "$option_argument"
    # XXX apparently this does not stop and exit with puppet errors here, why?
    $0 --puppet-chroot
    $0 --image

    ;;
  --build-chroot)
    build_chroot
    ;;
  --chroot)
    run_in_chroot bash
    ;;
  --prepare-puppet)
    set_debconf_seeds
    check_puppet_class "$option_argument"
    prepare_puppet "$option_argument"
    ;;
  --image)
    make_image
    ;;
  --puppet-chroot)
    apply_puppet
    ;;
  *)
    echo "Usage: $(basename $0) [--build|--chroot|--image]" >&2
    exit 1
    ;;
esac

exit 0
