#!/bin/sh

puavo_keyboard_layout=$(jq -r .keyboard_layout /etc/puavo/device.json)
puavo_keyboard_variant=$(jq -r .keyboard_variant /etc/puavo/device.json)
puavo_primary_user=$(jq -r .primary_user /etc/puavo/device.json)
puavo_greeter_background_mode=$(jq -r '.tags[]' /etc/puavo/device.json | sed -r -n 's/^greeter_background_mode://p' | tail -n1)
puavo_greeter_background=$(jq -r '.tags[]' /etc/puavo/device.json | sed -r -n 's/^greeter_background://p' | tail -n1)

background=

BACKGROUNDS_DIR=/usr/share/backgrounds/puavo-greeter

case "${puavo_greeter_background_mode}" in
    ''|static)
        ;;
    dynamic)
        if [ -n "${puavo_greeter_background}" ]; then
            find "${BACKGROUNDS_DIR}" -type f -printf '%P\n' \
                | grep -q -x "${puavo_greeter_background}" && {
                background="${BACKGROUNDS_DIR}/${puavo_greeter_background}"
            }
        fi
        ;;
    random)
        background=$(find "${BACKGROUNDS_DIR}" -maxdepth 1 -type f \( -name '*.png' -o -name '*.jpg' \) | sort -R | head -n1)
        ;;
    *)
        echo "unknown greeter background mode '${puavo_greeter_background_mode}'" >&2
        ;;
esac

[ "${puavo_keyboard_layout}" = "null" ] && puavo_keyboard_layout=
[ "${puavo_keyboard_variant}" = "null" ] && puavo_keyboard_variant=
[ "${puavo_primary_user}" = "null" ] && puavo_primary_user=

export XAUTHORITY=/var/run/lightdm/root/:0
export DISPLAY=:0

if [ "${puavo_keyboard_layout}" != "" ]; then
  setxkbmap ${puavo_keyboard_layout} ${puavo_keyboard_variant}
fi

if [ "${puavo_primary_user}" != "" ]; then
  mkdir -p /var/lib/lightdm/.config/dconf
  chown -R lightdm: /var/lib/lightdm/.config/dconf
  su -s /bin/sh lightdm -c "dbus-launch gsettings set com.canonical.unity-greeter default-user ${puavo_primary_user}"
  su -s /bin/sh lightdm -c "dbus-launch gsettings set com.canonical.unity-greeter exclude-prefixes \"['adm-', 'opinsys']\""
fi

if [ -n "${background}" ]; then
  mkdir -p /var/lib/lightdm/.config/dconf
  chown -R lightdm: /var/lib/lightdm/.config/dconf
  su -s /bin/sh lightdm -c "dbus-launch gsettings set com.canonical.unity-greeter background ${background}"
fi

exit 0
