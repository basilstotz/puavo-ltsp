# Do locale settings for this session. The language is picked from the
# first defined place in order: user language in session, session wide
# language (puavo-rest defines this as device language if user language
# is not set) and device language.
#
# Device language from device.json should be used only on laptop guest
# sessions when recent puavo-rest is used.

DEVICE_LANGUAGE=$(jq -r .preferred_language /etc/puavo/device.json)

if [ -f "${PUAVO_SESSION_PATH}" ]; then
  SESSION_LANGUAGE=$(jq -r .preferred_language "${PUAVO_SESSION_PATH}")
  USER_LANGUAGE=$(jq -r .user.preferred_language "${PUAVO_SESSION_PATH}")
fi

[ "${DEVICE_LANGUAGE}"  = "null" ] && DEVICE_LANGUAGE=
[ "${SESSION_LANGUAGE}" = "null" ] && SESSION_LANGUAGE=
[ "${USER_LANGUAGE}"    = "null" ] && USER_LANGUAGE=

if [ "${PUAVO_SESSION_LANGUAGE}" != "" ]; then
  PUAVO_LANGUAGE="${PUAVO_SESSION_LANGUAGE}"
elif [ "${USER_LANGUAGE}" != "" ]; then
  PUAVO_LANGUAGE="${USER_LANGUAGE}"
elif [ "${SESSION_LANGUAGE}" != "" ]; then
  PUAVO_LANGUAGE="${SESSION_LANGUAGE}"
elif [ "${DEVICE_LANGUAGE}" != "" ]; then
  PUAVO_LANGUAGE="${DEVICE_LANGUAGE}"
else
  # use English as a fallback language
  PUAVO_LANGUAGE=en_GB
fi

# set DCONF_PROFILE
case "$PUAVO_LANGUAGE" in
  de*) DCONF_PROFILE=user-de;;
  en*) DCONF_PROFILE=user-en;;
  fi*) DCONF_PROFILE=user-fi;;
  sv*) DCONF_PROFILE=user-sv;;
    *) DCONF_PROFILE=user-en;;
esac

# if full language type is not specified, expand it to default
# (like sv --> sv_FI), otherwise take the full type
case "$PUAVO_LANGUAGE" in
  *_*)
    LANG="${PUAVO_LANGUAGE}.UTF-8"
    LANGUAGE="${PUAVO_LANGUAGE}"
    ;;
  de)
    LANG=de_DE.UTF-8
    LANGUAGE=de
    ;;
  en)
    LANG=en_GB.UTF-8
    LANGUAGE=en
    ;;
  fi)
    LANG=fi_FI.UTF-8
    LANGUAGE=fi
    ;;
  ru)
    LANG=ru_RU.UTF-8
    LANGUAGE=ru
    ;;
  sv)
    LANG=sv_FI.UTF-8
    LANGUAGE=sv
    ;;
  *)
    echo "unknown langauge '${LANGUAGE}', falling back to 'en'" >&2
    LANG=en_GB.UTF-8
    LANGUAGE=en
    ;;
esac

export DCONF_PROFILE
export LANG
export LANGUAGE
