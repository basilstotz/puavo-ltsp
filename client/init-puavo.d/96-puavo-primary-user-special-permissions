puavo_get_device_param() {
  param_name=$1
  jq --raw-output ".${param_name}" /etc/puavo/device.json 2>/dev/null
}

cat /dev/null > /etc/polkit-1/localauthority/50-local.d/10.org.freedesktop.networkmanager.allow_modify_by_primary_user.pkla

if [ "$PUAVO_HOSTTYPE" = "laptop" \
     -a "$(puavo_get_device_param personal_device)" = "true" ]; then
  puavo_primary_user=$(puavo_get_device_param primary_user)
  if [ -n "$puavo_primary_user" -a "$puavo_primary_user" != "null" ]; then
    cat <<EOF > /etc/polkit-1/localauthority/50-local.d/10.org.freedesktop.networkmanager.allow_modify_by_primary_user.pkla
[Primary user permissions]
Identity=unix-user:${puavo_primary_user}
Action=org.freedesktop.NetworkManager.settings.modify.system
ResultAny=no
ResultInactive=no
ResultActive=yes
EOF
  fi
fi
