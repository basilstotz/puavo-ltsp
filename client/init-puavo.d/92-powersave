has_device_tag () {
  jq -r .tags[] /etc/puavo/device.json | grep -qx "$1"
}

# NMI watchdog

disable_nmi=0
enable_nmi=0
sata_alpm=0

if has_device_tag enable-nmi-watchdog; then
  enable_nmi=1
fi

if has_device_tag disable-nmi-watchdog; then
  disable_nmi=1
fi

if [ -f "/sys/devices/virtual/dmi/id/product_name" ]; then
  system=$(cat /sys/devices/virtual/dmi/id/product_name)
else
  system=$(dmidecode -s system-product-name)
fi

if [ "${system}" = "TravelMate B115-M" -o \
     "${system}" = "HP ProBook 430 G2" \
   ]; then
  disable_nmi=1
  sata_alpm=true
fi

if [ $enable_nmi != 0 ]; then
  echo 1 > /proc/sys/kernel/nmi_watchdog
else
  if [ $disable_nmi != 0 ]; then
    echo 0 > /proc/sys/kernel/nmi_watchdog
  fi
fi

# SATA link power management

if has_device_tag enable-sata-alpm; then
  sata_alpm=true
fi

if has_device_tag disable-sata-alpm; then
  sata_alpm=false
fi

if [ $sata_alpm != 0 ]; then
  echo SATA_ALPM_ENABLE=${sata_alpm} > /etc/pm/config.d/sata_alpm
fi
