PUAVO_HOSTTYPE=$(/bin/cat /etc/puavo/hosttype)

set_lts_var PUAVO_HOSTTYPE "$PUAVO_HOSTTYPE"

puavo_common_unneeded_services='
  anacron
  apport
  atd
  avahi-daemon
  cron
  cryptdisks-enable
  cryptdisks-udev
  epoptes
  epoptes-client
  gdm
  killprocs
  mountkernfs.sh
  nbd-server
  networking
  openvpn
  puppet
  rsync
  sendsigs
  ufw
  updatedb
  update-motd.d
  update-notifier
  winbind
'

puavo_nfs_services='gssd idmapd portmap rpcbind-boot'
puavo_tty_services='tty3 tty4 tty5 tty6'

set_lts_var LOCAL_APPS     False
set_lts_var NBD_SWAP       False
set_lts_var SYSLOG         False
set_lts_var USE_LOCAL_SWAP True
set_lts_var XKBLAYOUT      fi    # XXX especially this is highly opinionated

case "$PUAVO_HOSTTYPE" in
  fatclient)
    set_lts_var KEEP_SYSTEM_SERVICES "$puavo_nfs_services $puavo_tty_services"
    set_lts_var LOCALDEV             False
    set_lts_var LTSP_FATCLIENT       True
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      ltspguestssh
      ltspssh
      network-manager
      ntp
      ondemand
      puavo-load-balancer
      puavo-set-sane-date
      puavo-update-client
      puavo-vpn-client
      puavo-vpn-dnsmasq
    "
    set_lts_var SCREEN_07            lightdm
    set_lts_var USE_NFS_HOMES        True
    ;;
  laptop)
    if [ -n "$SERVER" ]; then
      # laptop booted off from network, offer to update it
      set_lts_var SCREEN_07 ltspimage-update
    else
      # laptop booted from local disk, provide lightdm
      set_lts_var SCREEN_07 lightdm
    fi

    # Laptops will keep the "ondemand"-task, removed from others.
    # A note about this: the service provides ondemand CPU frequency
    # scaling, meaning less power usage.  It is disabled by default,
    # but we want it for laptops.  However, on some machines, such as
    # "ETC-3800 machines" with "CentaurHauls, VIA Nehemiah" 800MHz processors,
    # the "ondemand" service makes the machines very unstable, so it should
    # be enabled with caution and perhaps on machine type basis.

    set_lts_var KEEP_SYSTEM_SERVICES "$puavo_tty_services ondemand"
    set_lts_var LOCALDEV             False
    set_lts_var LTSP_FATCLIENT       True
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      hostapd
      jetty
      ltspguestssh
      ltspssh
      mountnfs.sh
      puavo-load-balancer
      puavo-load-reporter
      puavo-monitor
      puavo-wlanap
      umountnfs.sh
      vtun
    "
    ;;
  ltspserver)
    set_lts_var KEEP_SYSTEM_SERVICES "$puavo_nfs_services $puavo_tty_services"
    set_lts_var LOCALDEV             False
    set_lts_var LTSP_FATCLIENT       False
    set_lts_var LTSP_SERVER          True
    set_lts_var RM_SESSION_SERVICES "
      ebeam
      mimio-mimiosys
      polyvision-cdfnu
      polyvision-pvd
      smart_1-_Service
      smart_1-_Tools
    "
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      eno
      network-manager
      nwfermi
      ondemand
      puavo-set-sane-date
      puavo-update-client
      puavo-vpn-dnsmasq
      zram-config
    "
    set_lts_var USE_NFS_HOMES        True
    ;;
  thinclient)
    set_lts_var KEEP_SYSTEM_SERVICES "$puavo_tty_services"
    set_lts_var LDM_AUTOLOGIN        False
    set_lts_var LDM_DIRECTX          True
    set_lts_var LDM_SESSION          'gnome-session --session=gnome-fallback'
    set_lts_var LOCALDEV             True
    set_lts_var LTSP_FATCLIENT       False
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      eno
      fluentd
      gssd
      ltspguestssh
      ltspssh
      network-manager
      ntp
      nwfermi
      ondemand
      puavo-load-balancer
      puavo-load-reporter
      puavo-set-sane-date
      puavo-sync-external-files
      puavo-update-client
      puavo-vpn-client
      puavo-vpn-dnsmasq
      sssd
      statd
      statd-mounting
      zram-config
    "
    set_lts_var SCREEN_07            lightdm
    set_lts_var SSH_OVERRIDE_PORT    222
    set_lts_var X_COLOR_DEPTH        16
    ;;
  unregistered)
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      eno
      fluentd
      gssd
      ltspguestssh
      ltspssh
      network-manager
      ntp
      nwfermi
      ondemand
      puavo-load-balancer
      puavo-load-reporter
      puavo-set-sane-date
      puavo-sync-external-files
      puavo-update-client
      puavo-vpn-client
      puavo-vpn-dnsmasq
      sssd
      statd
      statd-mounting
      zram-config
    "
    set_lts_var SCREEN_07          register
    ;;
  wirelessaccesspoint)
    if [ -n "$SERVER" ]; then
      # wirelessaccesspoint booted off from network, offer to update it
      set_lts_var SCREEN_07 ltspimage-update
    else
      # wirelessaccesspoint booted from local disk, provide another screen
      set_lts_var SCREEN_07 wirelessaccesspoint
    fi

    set_lts_var KEEP_SYSTEM_SERVICES "$puavo_tty_services"
    set_lts_var LOCALDEV             False
    set_lts_var LTSP_FATCLIENT       True
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      ltspguestssh
      ltspssh
      network-manager
      ondemand
      puavo-load-balancer
    "
    set_lts_var USE_NFS_HOMES        False
    ;;
esac
