PUAVO_HOSTTYPE=$(/bin/cat /etc/puavo/hosttype)
PERSONALLY_ADMINISTERED=$(jq -r .personally_administered /etc/puavo/device.json)

set_lts_var PUAVO_HOSTTYPE "$PUAVO_HOSTTYPE"

puavo_automatic_image_updates=$(jq -r .automatic_image_updates /etc/puavo/device.json)
puavo_personally_administered=$(jq -r .personally_administered /etc/puavo/device.json)

puavo_common_unneeded_services='
  anacron
  apport
  atd
  avahi-daemon
  cryptdisks-enable
  cryptdisks-udev
  epoptes
  epoptes-client
  gdm
  killprocs
  mountkernfs.sh
  nbd-server
  networking
  openvpn
  puppet
  rsync
  sendsigs
  ufw
  updatedb
  update-motd.d
  update-notifier
  winbind
'

# On personally administered devices we do not want to run fluentd and other
# reporting services as the data is not comparable to other devices.

if [ "${PERSONALLY_ADMINISTERED}" = "true" ]; then
  puavo_common_unneeded_services="${puavo_common_unneeded_services} fluentd puavo-hw-log"
fi

puavo_nfs_services='gssd idmapd portmap rpcbind-boot'
puavo_tty_services='tty3 tty4 tty5 tty6'

set_lts_var LOCAL_APPS     False
set_lts_var NBD_SWAP       False
set_lts_var SYSLOG         False
set_lts_var USE_LOCAL_SWAP True
set_lts_var XKBLAYOUT      fi    # XXX especially this is highly opinionated

case "$PUAVO_HOSTTYPE" in
  fatclient)
    set_lts_var KEEP_SYSTEM_SERVICES "$puavo_nfs_services $puavo_tty_services lightdm"
    set_lts_var LOCALDEV             False
    set_lts_var LTSP_FATCLIENT       True
    set_lts_var RM_SESSION_SERVICES "
      nm-applet
      puavo-client-updater-applet
    "
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      cron
      laptop-mode
      ltspguestssh
      ltspssh
      network-manager
      ntp
      ondemand
      puavo-load-balancer
      puavo-set-sane-date
      puavo-update-client
      puavo-vpn-client
      puavo-vpn-dnsmasq
      x2goserver
    "
    set_lts_var SCREEN_07     lightdm
    set_lts_var USE_NFS_HOMES True
    ;;
  laptop)
    # If laptop is booted from network, it should be updated instead of
    # launching a normal session. We use $SERVER variable that comes from
    # lts.conf to determine wheter we are network booting.
    if [ -n "$SERVER" ]; then
      # laptop booted off from network, offer to update it
      set_lts_var SCREEN_07 ltspimage-update
      rm_system_services="lightdm"
    else
      # laptop booted from local disk, provide lightdm
      set_lts_var SCREEN_07 lightdm
      keep_system_services="lightdm"
    fi

    # Laptops will keep the "ondemand"-task, removed from others.
    # A note about this: the service provides ondemand CPU frequency
    # scaling, meaning less power usage.  It is disabled by default,
    # but we want it for laptops.  However, on some machines, such as
    # "ETC-3800 machines" with "CentaurHauls, VIA Nehemiah" 800MHz processors,
    # the "ondemand" service makes the machines very unstable, so it should
    # be enabled with caution and perhaps on machine type basis.

    set_lts_var KEEP_SYSTEM_SERVICES "$puavo_tty_services $keep_system_services ondemand laptop-mode"
    set_lts_var LOCALDEV             False
    set_lts_var LTSP_FATCLIENT       True

    puavo_laptop_unneeded_session_services=""

    # puavo-client-updater-applet is not needed except on
    # personally administered laptops
    if [ "$puavo_personally_administered" != "true" ]; then
      puavo_laptop_unneeded_session_services="
        puavo-client-updater-applet
      "
    fi

    # do not start nm-applet on laptops when on webkiosk mode
    if jq -r .tags[] /etc/puavo/device.json | grep -qx webkiosk; then
      puavo_laptop_unneeded_session_services="
        $puavo_laptop_unneeded_session_services
        nm-applet
      "
    fi

    set_lts_var RM_SESSION_SERVICES "
      $puavo_laptop_unneeded_session_services
    "

    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      $rm_system_services 
      autopoweroff
      cron
      hostapd
      jetty
      ltspguestssh
      ltspssh
      mountnfs.sh
      puavo-load-balancer
      puavo-load-reporter
      puavo-monitor
      puavo-wlanap
      umountnfs.sh
      vtun
      x2goserver
    "
    ;;
  ltspserver)
    set_lts_var KEEP_SYSTEM_SERVICES "$puavo_nfs_services $puavo_tty_services"
    set_lts_var LOCALDEV             False
    set_lts_var LTSP_FATCLIENT       False
    set_lts_var LTSP_SERVER          True
    set_lts_var RM_SESSION_SERVICES "
      ebeam
      mimio-mimiosys
      nm-applet
      polyvision-cdfnu
      polyvision-pvd
      puavo-client-updater-applet
      smart_1-_Service
      smart_1-_Tools
    "
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      cron
      eno
      laptop-mode
      lightdm
      network-manager
      nwfermi
      ondemand
      puavo-set-sane-date
      puavo-update-client
      puavo-vpn-dnsmasq
      puavo-wlanap
      zram-config
    "
    set_lts_var SCREEN_07            ltspserver
    set_lts_var USE_NFS_HOMES        True
    ;;
  thinclient)
    set_lts_var KEEP_SYSTEM_SERVICES "$puavo_tty_services lightdm"
    set_lts_var LDM_AUTOLOGIN        False
    set_lts_var LDM_DIRECTX          True
    set_lts_var LDM_SESSION          'gnome-session --session=gnome-fallback'
    set_lts_var LOCALDEV             True
    set_lts_var LTSP_FATCLIENT       False
    set_lts_var RM_SESSION_SERVICES "
      nm-applet
      puavo-client-updater-applet
    "
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      cron
      eno
      fluentd
      gssd
      laptop-mode
      ltspguestssh
      ltspssh
      network-manager
      ntp
      nwfermi
      ondemand
      puavo-load-balancer
      puavo-load-reporter
      puavo-set-sane-date
      puavo-sync-external-files
      puavo-update-client
      puavo-vpn-client
      puavo-vpn-dnsmasq
      sssd
      statd
      statd-mounting
      x2goserver
      zram-config
    "
    set_lts_var SCREEN_07            lightdm
    set_lts_var SSH_OVERRIDE_PORT    222
    set_lts_var X_COLOR_DEPTH        16
    ;;
  unregistered)
    set_lts_var RM_SESSION_SERVICES "
      nm-applet
      puavo-client-updater-applet
    "
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      cron
      eno
      fluentd
      gssd
      laptop-mode
      lightdm
      ltspguestssh
      ltspssh
      network-manager
      ntp
      nwfermi
      ondemand
      puavo-load-balancer
      puavo-load-reporter
      puavo-set-sane-date
      puavo-sync-external-files
      puavo-update-client
      puavo-vpn-client
      puavo-vpn-dnsmasq
      puavo-wlanap
      sssd
      statd
      statd-mounting
      x2goserver
      zram-config
    "
    set_lts_var SCREEN_07          register
    ;;
  wirelessaccesspoint)
    if [ -n "$SERVER" ]; then
      # wirelessaccesspoint booted off from network, offer to update it
      set_lts_var SCREEN_07 ltspimage-update
      puavo_wirelessaccesspoint_unneeded_services="lightdm"
    elif jq -r .tags[] /etc/puavo/device.json | grep -qx infotv; then
      # if we are an infotv, we do want the lightdm to start up
      set_lts_var SCREEN_07 lightdm
      puavo_wirelessaccesspoint_unneeded_services=""
    else
      set_lts_var SCREEN_07 wirelessaccesspoint
      puavo_wirelessaccesspoint_unneeded_services="lightdm"
    fi

    set_lts_var KEEP_SYSTEM_SERVICES "$puavo_tty_services"
    set_lts_var LOCALDEV             False
    set_lts_var LTSP_FATCLIENT       True
    set_lts_var RM_SESSION_SERVICES "
      nm-applet
      puavo-client-updater-applet
    "
    set_lts_var RM_SYSTEM_SERVICES "
      $puavo_common_unneeded_services
      $puavo_wirelessaccesspoint_unneeded_services
      autopoweroff
      laptop-mode
      ltspguestssh
      ltspssh
      network-manager
      ondemand
      puavo-load-balancer
      x2goserver
    "
    set_lts_var USE_NFS_HOMES        False
    ;;
esac

if grep -q puavo_kdump_kernel /proc/cmdline; then
    rm -f /etc/init/lightdm.conf
    rm -f /etc/init.d/lightdm
    set_lts_var SCREEN_07 kdump
fi
